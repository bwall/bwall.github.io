<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Brian Wallace" />
        <meta name="copyright" content="Brian Wallace" />

        <meta name="description" content="The purpose of this post is to explain the TORQUE vulnerability I recently created a proof of concept for. Since the proof of concept was just a simple stub, I feel the mechanics behind the exploit should be described as well. TORQUE To be completely honest, I have never used ...
" />
<meta name="keywords" content="exploit, torque, stack, buffer overflow, Exploit, " />
        <title>TORQUE Exploitation Explained - Brian Wallace (@botnet_hunter)
</title>
        <link href="http://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="/theme/images/apple-touch-icon-144x144.png" />
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="/"><span class=site-name>Brian Wallace (@botnet_hunter)</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="/">Home</a></li>
                            <li ><a href="/categories.html">Categories</a></li>
                            <li ><a href="/tags.html">Tags</a></li>
                            <li ><a href="/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="/torque-exploitation-explained.html"> TORQUE Exploitation Explained  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            <p>The purpose of this post is to explain the TORQUE vulnerability I recently created a proof of concept for. Since the proof of concept was just a simple stub, I feel the mechanics behind the exploit should be described as well.</p>
<!-- more -->

<h1>TORQUE</h1>
<p>To be completely honest, I have never used TORQUE before attempting to exploit it.  I was looking for a vague CVE to proof of concept, and this one did not appear to obscure <a href="http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2014-0749">CVE-2014-0749</a>.  Since this application is open source, I was able to download and review the source code for this.  I was also able to see the <a href="https://github.com/adaptivecomputing/torque/commit/3ed749263abe3d69fa3626d142a5789dcb5a5684">pull request</a> for resolving this issue (easy mode, amirite?).</p>
<p>The line of code we are looking to exploit is <a href="https://github.com/adaptivecomputing/torque/blob/master/src/lib/Libdis/disrsi_.c#L100">here</a>.  Libdis defines the protocol used for network communication, and we are exploiting a weakness in its core ability to function.  I'll explain the relevant parts of this protocol.  Essentially, when reading in data, this protocol parses arbitrarily large data by first reading a digit.  This digit dictates how many digits will define how large the data will be.  Since the buffer for storing this data is only 64 bytes on an x64 machine, any value larger than two here will eventually lead in an overflow.  After it reads this first character, it then calls itself again to parse the digits for the size.  After parsing n digits, it now has its count for its final call to disrsi_.  In this call, we need to have it start with a digit again in order to reach the code we are exploiting.</p>
<p>The pull request mentioned before adds a check at the beginning of the function to check the size of data to be read in.  Since the check actually happens after information is read from the socket pre-pull request, we can read in as much as 999999999 bytes (actually quite a bit less due to section restrictions).  Looking at the code, this issue may not be apparent, as where is the memcpy we are supposed to be exploiting?  Its in the <a href="https://github.com/adaptivecomputing/torque/blob/85b58c5dd0abafe8e36450529e9a3df4e877039e/src/lib/Libifl/tcp_dis.c#L438">tcp_gets</a> at line <a href="https://github.com/adaptivecomputing/torque/blob/85b58c5dd0abafe8e36450529e9a3df4e877039e/src/lib/Libifl/tcp_dis.c#L467">467</a>.</p>
<p>So essentially, to exploit this, we need to send three numbers.  The first is a single digit which defines the number of digits in the next number, and the second defines the size of the data we will overflow with.  Then another digit to continue to hit the tcp_gets function we need to exploit.  We can simply connect with a TCP socket, send "39991" then 999 A's to cause the crash.</p>
<p><a href="http://www.exploit-db.com/exploits/33554/">Exploit Stub</a></p>
            <aside>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">« <a href="/extract-hosts.html" title="Previous: Extract Hosts">Extract Hosts</a></li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2014-06-02T21:42:00-07:00">Jun 2, 2014</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#Exploit-ref">Exploit</a> 
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#buffer-overflow-ref">buffer overflow
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#exploit-ref">exploit
                    <span>4</span>
</a></li>
                <li><a href="/tags.html#stack-ref">stack
                    <span>1</span>
</a></li>
                <li><a href="/tags.html#torque-ref">torque
                    <span>1</span>
</a></li>
            </ul>

        </div>
        </section>
    </div>
    </article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-subtitle"><span class="site-name">Brian Wallace (@botnet_hunter)</span> - A botnet hunter's blog</li>
        <li class="elegant-license">Site content © Copyright 2014 Brian Wallace</li>
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    </body>
</html>